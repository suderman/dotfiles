#!/usr/bin/env zsh

# https://wiki.archlinux.org/title/XDG_Base_Directory
config="$HOME/.config" # XDG_CONFIG_HOME
share="$HOME/.local/share"   # XDG_DATA_HOME
cache="$HOME/.cache"   # XDG_CACHE_HOME

# Shell helper functions
source $config/zsh/helpers.sh

echo_main() {
  defined $1 || return
  echo
  echo_line blue
  echo "$(echo_color black/on_blue " ★ ") $(echo_color blue " ${@} ")"
  echo_line blue
}

echo_next() {
  defined $1 || return
  echo
  echo "$(echo_color black/on_green " ▶︎ ") $(echo_color green " ${@} ")"
}

echo_run() {
  defined $1 || return
  echo "$1"
  eval "$1"
}

# Append line to end of file if it doesn't exist
append() {
  echo "\"$1\" >> $2"
  grep -q "^$1" $2 || echo "$1" >> $2
}

echo_main "Running updates"

# home directories
mkdir -p $config $share $cache

# oh-my-zsh
echo_next "Updating oh-my-zsh"
mkdir -p $share/zsh
git-clone-pull https://github.com/robbyrussell/oh-my-zsh.git $share/zsh/oh-my-zsh

# fzf
echo_next "Updating fzf"
git-clone-pull https://github.com/junegunn/fzf.git $share/fzf

# PHP Composer
if hasnt /work/.composer; then
  echo_next "Updating composer"
  mkdir -p $share/composer 
  ln -s $share/composer $HOME/.composer
fi

# WP-CLI
if hasnt wp; then
  composer global require wp-cli/wp-cli
fi

# npm
if hasnt $share/npm; then
  echo_next "Updating npm"
  mkdir -p $share/npm $cache/npm
fi

# tmux plugin manager
echo_next "Updating tmux"
mkdir -p $share/tmux/plugins
git-clone-pull https://github.com/tmux-plugins/tpm.git $share/tmux/plugins/tpm
if has $share/tmux/plugins/tpm/bin/install_plugins; then 
  echo "$share/tmux/plugins/tpm/bin/install_plugins"
  $share/tmux/plugins/tpm/bin/install_plugins
fi

# vim-plug
echo_next "Updating nvim"
mkdir -p $share/nvim/site/{autoload,plugged}
curl -fL https://github.com/junegunn/vim-plug/raw/master/plug.vim > $share/nvim/site/autoload/plug.vim
has $share/nvim/site/autoload/custom.vim || cp $config/nvim/custom.vim $share/nvim/site/autoload/custom.vim
echo "nvim +PlugInstall +qall >> /dev/null"
nvim +PlugInstall +qall >> /dev/null

echo_next "...done!"
